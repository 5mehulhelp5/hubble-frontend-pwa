# Platform: Shopware
Contains all files that are related to usage of hubble PWA with Shopware 6.

## Requirements
- Shopware >= 6.4.14.0
- [SwagShopwarePwa](https://github.com/shopware/SwagShopwarePwa) = 0.3.3

## api-client
The API Client for this platform is generated by https://github.com/ferdikoomen/openapi-typescript-codegen.

### Generate
To generate / update the client:
1. Create a Shopware Integration (required only once per setup) https://docs.shopware.com/en/shopware-6-en/settings/system/integrationen
2. Set credentials as cli env variables
```shell
export PLATFORM_BASE_URL=http://localhost
export API_CLIENT_ID=your-shopware-client-id
export API_CLIENT_SECRET=your-shopware-client-secret
```
3. Run helper cli script
```shell
npm run sw:dev:generate-api
```

### Patch
Because the client is generated from the swagger comments of shopware, there can be mismatches in types or functions. 
Patch files are applied automatically on client generation. 
In this case you can patch missing or wrong code on your own:

1. Change to root directory
2. Commit your changes to git 
3. Create patch:
```shell
export COMMIT=commit-hash-from-1
npm run sw:dev:patch-api
```
4. Commit generated path file to git 

### Usage
Use api client directly in platform specific composables only to keep backend agnostic.
Given services can be found in shopware/api-client/generated/services
```js
import { CategoryShopware } from '../api-client/generated'

const { data, pending, refresh } = await CategoryShopware.readNavigation(
    'main-navigation',
    'main-navigation',
    {},
    true
)
```

### Custom request.ts
- sets shopware specific default headers: **sw-access-key** and **sw-include-seo-urls** and **sw-language-id**
- sets shopware specific header **sw-context-token** if exists as cookie or in store 
- uses $fetch function of oh-my-fetch for xhr requests 
- handles errors 

## bin
Contains shopware specific cli helper like api client generation and plugin installation / configuration.

## composables
Contains shopware specific composables. Mostly used to fetch data from api via 
platform specific api client and map them to types / interfaces defined in /runtime/commons. 

## .env_example
Example file for shopware specific environment variables 

## Plugins

### Install Plugins from Shopware 

Plugin data will be dumped from Shopware via API. The dumped zip file will be downloaded and unzipped in /platform-plugins 
of projects rootDir. All plugin slot mapping files will be merged and placed as pluginMapping.json in /platform-plugins
of projects rootDir. 

```shell
npm run hubble dev:sw sw-plugins-assets
```

### Load Plugin Configurations from Shopware

Plugin data will be dumped from Shopware via API. The dumped plugin configuration will be flattened and merged into one
single object, so it can be injected to Nuxt.js public runtimeConfiguration. Config file will be placed in /platform-plugins
of projects rootDir. 

Config values which contain "secret" or "private" or "password", will NOT be injected to avoid to leak sensitive
information. 

Schema of object property:

```json
{
    "camelCasePluginNameConfigName": "some config value" 
}
```

```shell
npm run hubble dev:sw sw-plugins-config
```

## Languages
For translations the module @intlify/nuxt3 is used. 
The middleware `change-vue-locale.global.ts` sets the language depending on the
current localisation key of the url. 

Following files are related to the translation process:
```text
/components
    /misc
        /MiscDefineLink.ts
        /MiscLink.vue
/locales
    /availableLocales.json
    /platformLanguages.json
/middleware
    /change-vue-locale.global.ts
/platforms
    /shopware
        /bin
            /sw-languages.js
        /composables
            /useLocalisation.ts
```

### Configuration
hubble sets some default configuration for intlify and vueI18n, to override them, they
have to be set via hubble module options. 

```js
export default defineNuxtConfig({
    hubble: {
        intlify: { // <= Override intlify module options
            vueI18n: { // <= Override vueI18n module options
                ...
            }
        }
    },
})
```

#### redirectDefaultLanguage
If set true, all requests to the localised default route will redirect to the non localised route. 
Default isset to false.

e.g.: default locale is 'de'. Requested page: domain.com/de/my-page will redirected to domain.com/my-page.

```js
export default defineNuxtConfig({
    hubble: {
        redirectDefaultLanguage: true
    },
})
```

### MiscLink.vue
A custom component which uses defineNuxtLink in `/components/misc/MiscDefineLink.ts` to behave like a regular
NuxtLink, but take care of your current localized route.

IMPORTANT: For all links you have to use the MiscLink instead of NuxtLink. 
Otherwise, users could land on a localised route with wrong languageId set and get 404 errors from Shopware. 

### `locales/availableLocales.json`
Contains an array of language keys, used to generate localised routes of all available pages.
The first language is set as the default / fallback language.

### `locales/platformLanguages.json`
This file is created by the shopware helper script `/bin/sw-languages.js`.
It contains an array of objects of the response of /store-api/language of the configured Saleschannel / sw-access-key 
in .env file. 

To connect a localised route to a platform language, add a "route" to the objects in `platformLanguages.json`.

```js
[
    {
        "route": "de", // <= key from locales/availableLocales.json
        "id": "2fbb5fe2e29a4d70aa5854ce7ce3e20b",
        "code": "de-DE",
        "name": "Deutsch"
    },
    {
        "route": "en",
        "id": "669293859c85406c832315184f775f0c",
        "code": "en-GB",
        "name": "Englisch"
    }
]
```

IMPORTANT: Make sure you set the languages in the saleschannels settings and created a domain
which uses the language, otherwise Shopware won't generate the seo urls for the requested language id.

## Usage in Components

To translate a string inside a component, make use of the useI18n composable and a `<i18n>` node to provide translations:

```vue
<template>
    {{ t('custom.component.headline') }}
</template>

<script setup>
import { useI18n } from 'vue-i18n'
const { t } = useI18n()
</script>

<i18n>
{
    "en": {
        "custom.component.headline": "Title"
    },
    "de": {
        "custom.component.headline": "Ãœberschrift"
    }
}
</i18n>
```

## How to Multilanguage 
1. Add the required language in Admin -> Settings -> Languages
2. Add the new language to your Sales-Channel in Sales-Channel -> Base Settings -> Languages
3. Assign the language to an existing domain of your Sales-Channel or create a new domain
4. Create a `/locales/availableLocales.json` file and define the languages you want to provide
5. Download and save all languages available for your Sales-Channel from Shopware by execute this script in your projects root dir:
```shell
npm run hubble dev:sw sw-languages
```
6. Edit the created `locales/platformLanguages.json` file and assign an available locale to
a downloaded language by adding a "route" key and the language key as a value. 

## Translation CSV export / import

Sometimes you may want to change many translations at one time or add / remove a language from the translations inside
the components. So that you don't have to edit them in every of your files, we build a CSV Import / Export.

Add helper scripts to your `package.json`:
```json
...
"scripts": {
    "i18n:export": "node bin/hubble-cli.js i18n-export",
    "i18n:import": "node bin/hubble-cli.js i18n-import"
}
...
```

Export / Import:
```shell
npm run i18n:export ./i18n.csv
npm run i18n:import ./i18n.csv
```
